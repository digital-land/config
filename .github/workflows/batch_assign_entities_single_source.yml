name: Batch assign entities (single source)

on:
  workflow_dispatch:

jobs:
  run-and-pr:
    runs-on: ubuntu-latest

    steps:
      # Checkout config repo
      - name: Checkout config
        uses: actions/checkout@v4
        with:
          submodules: false

      # Checkout specification repo (temporary working copy only)
      - name: Checkout specification
        uses: actions/checkout@v4
        with:
          repository: digital-land/specification
          path: specification-src
          submodules: false

      # Prepare full specification directory
      - name: Prepare specification
        run: |
          rm -rf specification
          cp -r specification-src/specification specification
          rm -rf specification-src

      # Prepare organisation cache
      - name: Prepare organisation cache
        run: |
          mkdir -p var/cache
          curl -sSL \
            https://raw.githubusercontent.com/digital-land/organisation-dataset/main/organisation.csv \
            -o var/cache/organisation.csv

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Install dependencies (CI-safe)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

          # Install Digital Land library (non-editable)
          pip install git+https://github.com/digital-land/digital-land-python.git

          # Install repo requirements without editable installs
          grep -v '^.*digital-land-python.*$' requirements.txt > /tmp/requirements-ci.txt
          pip install -r /tmp/requirements-ci.txt

          # Explicit runtime dependency
          pip install pandas

      # Run batch entity assignment (force non-interactive)
      - name: Run batch entities
        env:
          DIGITAL_LAND_ASSUME_YES: "1"
          DIGITAL_LAND_NON_INTERACTIVE: "1"
        run: |
          yes | python bin/batch_assign_entities_single_source.py

      # Stage everything, then keep ONLY lookup.csv
      - name: Keep only lookup.csv changes
        run: |
          # Stage everything first
          git add -A

          # Restore everything except lookup.csv (index + working tree)
          git restore --staged --worktree --source=HEAD -- . ':(exclude)lookup.csv'

          # Ensure lookup.csv is staged if present
          git add lookup.csv 2>/dev/null || true

      # Detect whether lookup.csv changed
      - name: Check for lookup.csv changes
        id: lookup_diff
        run: |
          if git diff --name-only --cached -- lookup.csv | grep -q .; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # Create PR only if lookup.csv changed
      - name: Create pull request
        if: steps.lookup_diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Update lookup.csv"
          title: "Update lookup.csv"
          body: |
            Automated update of `lookup.csv` generated by
            `bin/batch_assign_entities_single_source.py`.

            - Runs in non-interactive CI mode
            - Uses the full Digital Land specification
            - Commits **only** lookup changes
          branch: batch-assign-entities-single-source
          delete-branch: true
          labels: |
            automated
            data
            lookup
